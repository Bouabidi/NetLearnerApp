

			
				
	<article id="post-5553" class="post-5553 post type-post status-publish format-standard hentry category-asp-net category-database category-learn category-visual-studio category-web-development">
				<header class="entry-header">
			
						<h1 class="entry-title">Zero-Downtime* Web Apps for ASP .NET Core 3.1</h1>
			<div>By  Shahed C on June 29, 2020</div>
							<div class="comments-link">
					<a href="https://wakeupandcode.com/zero-downtime-web-apps-for-asp-net-core-3-1/#comments">2 Replies</a>				</div><!-- .comments-link -->
					</header><!-- .entry-header -->

				<div class="entry-content">
			
<figure class="wp-block-image size-large"><img src="https://wakeupandcode.com/wp-content/uploads/2020/01/aspnetcore-az-banner.png" alt="" class="wp-image-4421" srcset="https://wakeupandcode.com/wp-content/uploads/2020/01/aspnetcore-az-banner.png 573w, https://wakeupandcode.com/wp-content/uploads/2020/01/aspnetcore-az-banner-300x64.png 300w" sizes="(max-width: 573px) 100vw, 573px"></figure>



<p>This is&nbsp;the twenty-sixth of a new&nbsp;<a rel="noreferrer noopener" href="https://wakeupandcode.com/aspnetcore/#aspnetcore2020" target="_blank">series of posts</a>&nbsp;on ASP .NET Core 3.1 for 2020. In this series, we’ve covered 26 topics over a span of 26 weeks from January through June 2020, titled&nbsp;<strong>ASP .NET Core A-Z!</strong>&nbsp;To differentiate from the&nbsp;<a href="https://wakeupandcode.com/aspnetcore/#aspnetcore2019">2019 series</a>, the 2020 series mostly focused on a growing single codebase (<a href="https://wakeupandcode.com/netlearner-on-asp-net-core-3-1/">NetLearner!</a>) instead of new unrelated code snippets week.</p>



<p>Previous post:</p>



<ul><li><a href="https://wakeupandcode.com/yaml-defined-ci-cd-for-asp-net-core-3-1/">YAML-defined CI/CD for ASP .NET Core 3.1</a></li></ul>



<p><strong>NetLearner on GitHub</strong>:</p>



<ul><li>Repository:&nbsp;<a href="https://github.com/shahedc/NetLearnerApp">https://github.com/shahedc/NetLearnerApp</a></li><li>v0.26-alpha release:&nbsp;<a href="https://github.com/shahedc/NetLearnerApp/releases/tag/v0.26-alpha">https://github.com/shahedc/NetLearnerApp/releases/tag/v0.26-alpha</a></li></ul>



<h1>In this Article:</h1>



<ul><li><a href="#Z">Z is for Zero-Downtime* Web Apps</a></li><li><a href="#avail">Availability</a></li><li><a href="#backup">Backup &amp; Restore</a></li><li><a href="#cicd">Continuous Integration &amp; Continuous Deployment</a></li><li><a href="#slots">Deployment Slots</a></li><li><a href="#migrations">EF Core Migrations in Production</a></li><li><a href="#flags">Feature Flags</a></li><li><a href="#refs">References</a></li></ul>



<p><a name="Z"></a></p>
<h1>Z is for Zero-Downtime* Web Apps for ASP .NET Core</h1>



<p>If you’ve made it this far in this ASP .NET Core A-Z series,&nbsp;hopefully you’ve learned about many important topics related to ASP .NET Core web application development. As we wrap up this series with a look at tips and tricks to&nbsp;<em>attempt</em>&nbsp;zero-downtime, this last post itself has its own lettered A-F mini-series:&nbsp;<strong>A</strong>vailability,&nbsp;<strong>B</strong>ackup &amp; Restore,&nbsp;<strong>C</strong>I/CD,&nbsp;<strong>D</strong>eployment Slots,&nbsp;<strong>E</strong>F Core Migrations and&nbsp;<strong>F</strong>eature Flags.</p>



<figure class="wp-block-image size-large"><img src="https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-diagram-1024x427.png" alt="" class="wp-image-5698" srcset="https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-diagram-1024x427.png 1024w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-diagram-300x125.png 300w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-diagram-1536x640.png 1536w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-diagram-624x260.png 624w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-diagram.png 1728w" sizes="(max-width: 1024px) 100vw, 1024px"><figcaption>Deploying to Staging Slots in AsuApp Service</figcaption></figure>



<p><strong>NOTE</strong>: While it may not be possible to get 100% availability 24/7/365, you can ensure a&nbsp;user-friendly experience free from (or at least with minimal) interruptions, by following a combination of the tips and tricks outlined below.&nbsp;This write-up is not meant to be a comprehensive guide. Rather, it&nbsp;is more of an outline with references that you can follow up on, for next steps.</p>



<p><a name="avail"></a></p>
<h1>Availability</h1>



<p>To improve the availability of your ASP .NET Core web app running on Azure, consider running your app in multiple regions for HA (High Availability). To control traffic to/from your website, you may use&nbsp;<a href="https://docs.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">Traffic Manager</a>&nbsp;to direct web traffic to a standby/secondary region, in case the primary region is unavailable.</p>



<p>Consider the following 3 options when running a web app in multiple Azure regions. In these scenarios, the primary region is always active and the secondary region may be passive (as a hot or cold standby) or active. When both are active, web requests are load-balanced between the two regions.</p>



<figure class="wp-block-table"><table class=""><tbody><tr><td>&nbsp;<strong>Options</strong></td><td><strong>Primary Region</strong></td><td><strong>Secondary Region</strong></td></tr><tr><td>A</td><td>Active</td><td>Passive, Hot Standby</td></tr><tr><td>B</td><td>Active</td><td>Passive, Cold Standby</td></tr><tr><td>C</td><td>Active</td><td>Active</td></tr></tbody></table></figure>



<p>For more information on achieving High Availability (HA) in multiple regions, check out the official docs at:</p>



<ul><li>HA multi-region web apps:  <a href="https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/app-service-web-app/multi-region">https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/app-service-web-app/multi-region</a> </li></ul>



<p>If you’re running your web app in a Virtual Machine (VM) instead of Azure App Service, you may also consider&nbsp;<a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability" target="_blank">Availability Sets</a>. This helps build redundancy in your Web App’s architecture,&nbsp;when you have 2 or more VMs in an Availability Set. For added resiliency, use&nbsp;<a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview" target="_blank">Azure Load Balancer</a>&nbsp;with your VMs to load-balance incoming traffic.&nbsp;As an alternative&nbsp;to Availability Sets, you may also use&nbsp;<a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://docs.microsoft.com/en-us/azure/availability-zones/az-overview" target="_blank">Availability Zones</a>&nbsp;to counter any failures within a datacenter.</p>



<p><a name="backup"></a></p>
<h1>Backup &amp; Restore</h1>



<p>Azure’s App Service lets you&nbsp;<a href="https://docs.microsoft.com/en-us/azure/app-service/manage-backup" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">back up and restore</a>&nbsp;your web application, using the Azure Portal or with&nbsp;<a href="https://docs.microsoft.com/en-us/azure/app-service/scripts/cli-backup-onetime" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">Azure CLI commands</a>. Note that this requires your App Service to be in at least the Standard or Premium tier, as it is not available in the Free/Shared tiers. You can create backups on demand when you wish, or schedule your backups as needed.&nbsp;If your site goes down, you can quickly restore your last good backup to minimize downtime.</p>



<figure class="wp-block-image size-large"><img src="https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-backups-1024x598.png" alt="" class="wp-image-5707" srcset="https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-backups-1024x598.png 1024w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-backups-300x175.png 300w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-backups-1536x897.png 1536w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-backups-2048x1197.png 2048w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-backups-624x365.png 624w" sizes="(max-width: 1024px) 100vw, 1024px"><figcaption>App Service: Backups</figcaption></figure>



<p><strong>NOTE</strong>: You may use the new Snapshots feature to <em>&#8220;automatically create perioidic restore points of your app&#8221;</em>. However, this feature is only available in a Premium App Service Plan.</p>



<p>In addition to the app itself, the backup process also backs up the Web App’s configuration, file contents and the database connected to your app. Database types include SQL DB (aka SQL Server PaaS), MySQL and PostgreSQL. Note that these backups include a&nbsp;<em>complete</em>&nbsp;backup, and not incremental/delta backups.</p>



<p><a name="cicd"></a></p>
<h1>Continuous Integration &amp; Continuous Deployment</h1>



<p>In the&nbsp;<a href="https://wakeupandcode.com/yaml-defined-ci-cd-for-asp-net-core-3-1/" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">previous post</a>, we covered CI/CD with YAML pipelines. Whether you have to fix an urgent bug quickly or just deploy a planned release, it’s important to have a proper CI/CD pipeline. This allows you to deploy new features and fixes quickly with minimal downtime.</p>



<figure class="wp-block-image size-large"><img src="https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-azdo-edit-1024x556.png" alt="" class="wp-image-5711" srcset="https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-azdo-edit-1024x556.png 1024w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-azdo-edit-300x163.png 300w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-azdo-edit-1536x834.png 1536w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-azdo-edit-2048x1112.png 2048w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-azdo-edit-624x339.png 624w" sizes="(max-width: 1024px) 100vw, 1024px"><figcaption>YAML Sample in Azure DevOps</figcaption></figure>



<ul><li>YAML Sample:  <a href="https://github.com/shahedc/NetLearnerApp/blob/main/azure-pipelines.yml.txt">https://github.com/shahedc/NetLearnerApp/blob/main/azure-pipelines.yml.txt</a> </li></ul>



<p><a name="slots"></a></p>
<h1>Deployment Slots</h1>



<p>Whether you’re deploying your Web App to App Service for the first time or the 100th time, it helps to test out your app before releasing to the public.&nbsp;<a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">Deployment slots</a>&nbsp;make it easy to set up a&nbsp;<em>Staging Slot</em>, warm it up and swap it immediately with a&nbsp;<em>Production Slot</em>. Swapping a slot that has already been warmed up ahead of time will allow you to deploy the latest version of your Web App almost immediately.</p>



<figure class="wp-block-image size-large"><img src="https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-slots-1024x445.png" alt="Deployment Slots in Azure App Service" class="wp-image-5714" srcset="https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-slots-1024x445.png 1024w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-slots-300x130.png 300w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-slots-1536x668.png 1536w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-slots-2048x891.png 2048w, https://wakeupandcode.com/wp-content/uploads/2020/06/zerodown-slots-624x271.png 624w" sizes="(max-width: 1024px) 100vw, 1024px"><figcaption>Deployment Slots in Azure App Service</figcaption></figure>



<p>Note that&nbsp;Deployment Slots are only available in Standard, Premium or Isolated App Service tiers, not in the Free/Shared tiers. You can combine Deployment Slots with your CI/CD pipelines to ensure that your automated deployments end up in the intended slots.</p>



<p><a name="migrations"></a></p>
<h1>EF Core Migrations in Production</h1>



<p>We covered&nbsp;<a href="https://wakeupandcode.com/ef-core-migrations-in-asp-net-core/" target="_blank" rel="noreferrer noopener">EF Core Migrations</a>&nbsp;in a previous post, which is one&nbsp;way of upgrading your database in various environments (including production).&nbsp;<em>But wait, is it safe to run EF Core Migrations in a production environment?&nbsp;</em>Even though you can&nbsp;use auto-generated EF Core migrations (written in C# or outputted as SQL Scripts), you may also&nbsp;modify your migrations for your needs.</p>



<p>I would highly recommend reading&nbsp;<a href="https://twitter.com/thereformedprog" target="_blank" rel="noreferrer noopener">Jon P Smith</a>‘s two-part series on&nbsp;“Handling Entity Framework Core database migrations in production”:</p>



<ul><li>Part 1 of 2:&nbsp;<a href="https://www.thereformedprogrammer.net/handling-entity-framework-core-database-migrations-in-production-part-1/" target="_blank" rel="noreferrer noopener">https://www.thereformedprogrammer.net/handling-entity-framework-core-database-migrations-in-production-part-1/</a></li><li>Part 2 of 2:&nbsp;<a href="https://www.thereformedprogrammer.net/handling-entity-framework-core-database-migrations-in-production-part-2/" target="_blank" rel="noreferrer noopener">https://www.thereformedprogrammer.net/handling-entity-framework-core-database-migrations-in-production-part-2/</a></li></ul>



<p>What you decide to do is up to you (and your team). I would suggest exploring the different options available to you, to ensure that you minimize any downtime for your users. For any&nbsp;<em>non-breaking</em>&nbsp;DB changes, you should be able to migrate your DB easily. However, your site may be down for maintenance for any&nbsp;<em>breaking</em>&nbsp;DB changes.</p>



<p><a name="flags"></a></p>
<h1>Feature Flags</h1>



<p>Introduced by the Azure team, the&nbsp;<a href="https://www.nuget.org/packages/Microsoft.FeatureManagement/" target="_blank" rel="noreferrer noopener" aria-label="Microsoft.FeatureManage (opens in a new tab)">Microsoft.FeatureManage</a><a rel="noreferrer noopener" href="http://microsoft.featuremanagement/" target="_blank">ment</a>&nbsp;package allows you to add&nbsp;<a href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/quickstart-feature-flag-aspnet-core" target="_blank" rel="noreferrer noopener" aria-label=" (opens in a new tab)">Feature Flags</a>&nbsp;to your .NET application. This enables your web app to include new features that can easily be toggled for various audiences. This means that you could potentially test out new features by deploying&nbsp;them during off-peak times, but toggling them to become available via app configuration.</p>



<p>To install the package, you may use the following&nbsp;<strong>dotnet</strong>&nbsp;command:</p>



<span style="color: #808080;font-family: Courier New;">&gt;dotnet add package Microsoft.FeatureManagement --version 2.0.0</span>



<p>If you prefer the Package Manager Console in Visual Studio, you may also use the following PowerShell command:</p>



<span style="color: #808080;font-family: Courier New;">&gt;Install-Package Microsoft.FeatureManagement -Version 2.0.0</span>



<p>By combining many/all of the above features, tips and tricks for your Web App deployments, you can&nbsp;release new features while minimizing/eliminating downtime. If you have any new suggestions, feel free to leave your comments.</p>



<p><a name="refs"></a></p>
<h1>References</h1>



<ul><li> Highly available multi-region web application:&nbsp;<a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/app-service-web-app/multi-region" target="_blank">https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/app-service-web-app/multi-region</a></li><li> Design reliable Azure applications:&nbsp;<a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/architecture/reliability/" target="_blank">https://docs.microsoft.com/en-us/azure/architecture/reliability/</a></li><li> Manage the availability of Windows VMs in Azure: <a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability" target="_blank">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability</a></li><li> What is Azure Load Balancer? <a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview" target="_blank">https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview</a></li><li> SLA for VMs:&nbsp;<a rel="noreferrer noopener" href="https://azure.microsoft.com/en-us/support/legal/sla/virtual-machines/" target="_blank">https://azure.microsoft.com/en-us/support/legal/sla/virtual-machines/</a></li><li> Back up app &#8211; Azure App Service:&nbsp;<a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/app-service/manage-backup" target="_blank">https://docs.microsoft.com/en-us/azure/app-service/manage-backup</a></li><li> Azure CLI Script Sample &#8211; Back up an app:&nbsp;<a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/app-service/scripts/cli-backup-onetime" target="_blank">https://docs.microsoft.com/en-us/azure/app-service/scripts/cli-backup-onetime</a></li><li> CI/CD with Release pipelines: <a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release" target="_blank">https://docs.microsoft.com/en-us/azure/devops/pipelines/release</a></li><li> Continuous deployment &#8211; Azure App Service: <a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/app-service/deploy-continuous-deployment" target="_blank">https://docs.microsoft.com/en-us/azure/app-service/deploy-continuous-deployment</a></li><li> Set up staging environments for web apps in Azure App Service: <a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots" target="_blank">https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots</a></li><li> Handling Entity Framework Core database migrations in production:&nbsp;<a rel="noreferrer noopener" href="https://www.thereformedprogrammer.net/handling-entity-framework-core-database-migrations-in-production-part-1/" target="_blank">https://www.thereformedprogrammer.net/handling-entity-framework-core-database-migrations-in-production-part-1/</a></li><li> Handling Entity Framework Core database migrations in production – Part 2:&nbsp;<a rel="noreferrer noopener" href="https://www.thereformedprogrammer.net/handling-entity-framework-core-database-migrations-in-production-part-2/" target="_blank">https://www.thereformedprogrammer.net/handling-entity-framework-core-database-migrations-in-production-part-2/</a></li><li> Tutorial for using feature flags in a .NET Core app: <a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/use-feature-flags-dotnet-core" target="_blank">https://docs.microsoft.com/en-us/azure/azure-app-configuration/use-feature-flags-dotnet-core</a></li><li> Quickstart for adding feature flags to ASP.NET Core:&nbsp;<a rel="noreferrer noopener" href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/quickstart-feature-flag-aspnet-core" target="_blank">https://docs.microsoft.com/en-us/azure/azure-app-configuration/quickstart-feature-flag-aspnet-core</a> </li></ul>
					</div><!-- .entry-content -->
		
		<!-- .entry-meta -->
	</article><!-- #post -->

				<!-- .nav-single -->

				
<!-- #comments .comments-area -->
			
		